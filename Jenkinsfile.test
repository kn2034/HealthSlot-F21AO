#!/usr/bin/env groovy

// Test pipeline for HealthSlot project
pipeline {
    agent {
        label 'built-in'
    }
    
    options {
        skipDefaultCheckout(false)
        disableConcurrentBuilds()
    }
    
    environment {
        NODE_VERSION = 'v16'
        DOCKER_IMAGE = 'healthslot'
        DOCKER_TAG = "${env.BUILD_NUMBER}"
        DOCKER_CREDENTIALS = credentials('docker-hub-credentials')
        KUBECONFIG_CREDENTIALS = credentials('kubeconfig-credentials')
        JIRA_SITE = 'healthslot-jira'
    }
    
    stages {
        stage('Verify Pipeline') {
            steps {
                script {
                    echo 'Verifying pipeline configuration...'
                    echo "Running from file: Jenkinsfile.test"
                    echo "Current workspace: ${WORKSPACE}"
                }
            }
        }
        
        stage('Verify Environment') {
            steps {
                script {
                    echo 'Checking build environment...'
                    sh '''
                        echo "Workspace directory:"
                        pwd
                        echo "System information:"
                        uname -a
                        echo "Current user:"
                        whoami
                    '''
                }
            }
        }
        
        stage('Setup Node.js') {
            steps {
                script {
                    try {
                        sh 'node --version'
                    } catch (err) {
                        echo 'Node.js not found, installing...'
                        sh '''
                            curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
                            export NVM_DIR="$HOME/.nvm"
                            if [ -f "$NVM_DIR/nvm.sh" ]; then
                                . "$NVM_DIR/nvm.sh"
                                nvm install ${NODE_VERSION}
                                nvm use ${NODE_VERSION}
                            else
                                echo "NVM installation failed"
                                exit 1
                            fi
                        '''
                    }
                }
            }
        }
        
        stage('Install Dependencies') {
            steps {
                script {
                    try {
                        sh '''
                            # Install all dependencies including dev dependencies
                            npm install
                            
                            # Explicitly install mongodb-memory-server if not present
                            if ! npm list mongodb-memory-server >/dev/null 2>&1; then
                                echo "Installing mongodb-memory-server..."
                                npm install --save-dev mongodb-memory-server@latest
                            fi
                            
                            # Verify mongodb-memory-server installation
                            npm list mongodb-memory-server
                        '''
                    } catch (err) {
                        echo "Error installing dependencies: ${err}"
                        unstable('Failed to install dependencies')
                        error 'Failed to install dependencies'
                    }
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    try {
                        sh '''
                            # Set NODE_ENV to test
                            export NODE_ENV=test
                            
                            # Run tests with increased memory limit and timeout
                            NODE_OPTIONS="--max-old-space-size=4096" npm test -- --detectOpenHandles --forceExit
                        '''
                    } catch (err) {
                        echo "Error running tests: ${err}"
                        unstable('Tests failed')
                        error 'Tests failed'
                    }
                }
            }
            post {
                always {
                    junit '**/test-results.xml'
                }
            }
        }
        
        stage('Build Docker Image') {
            steps {
                script {
                    docker.build("${DOCKER_IMAGE}:${DOCKER_TAG}")
                }
            }
        }
        
        stage('Push Docker Image') {
            steps {
                script {
                    docker.withRegistry('https://registry.hub.docker.com', DOCKER_CREDENTIALS) {
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push()
                        docker.image("${DOCKER_IMAGE}:${DOCKER_TAG}").push('latest')
                    }
                }
            }
        }
        
        stage('Deploy to Staging') {
            when {
                branch 'development'
            }
            steps {
                withKubeConfig([credentialsId: KUBECONFIG_CREDENTIALS]) {
                    sh '''
                        # Apply configurations in order
                        kubectl apply -f k8s/namespaces.yaml
                        kubectl apply -f k8s/staging/configmap.yaml
                        kubectl apply -f k8s/staging/mongodb.yaml
                        kubectl apply -f k8s/staging/app-deployment.yaml
                        
                        # Update image
                        kubectl set image deployment/healthslot-staging healthslot=${DOCKER_IMAGE}:${DOCKER_TAG} -n staging
                        
                        # Wait for rollout
                        kubectl rollout status deployment/healthslot-staging -n staging
                    '''
                }
            }
        }
    }
    
    post {
        always {
            script {
                echo 'Cleaning workspace...'
                cleanWs(
                    cleanWhenSuccess: true,
                    cleanWhenFailure: true,
                    cleanWhenUnstable: true,
                    deleteDirs: true
                )
            }
        }
        success {
            script {
                jiraSendBuildInfo site: JIRA_SITE, branch: env.BRANCH_NAME
            }
            echo 'Pipeline completed successfully!'
        }
        failure {
            script {
                jiraSendBuildInfo site: JIRA_SITE, branch: env.BRANCH_NAME
            }
            echo 'Pipeline failed! Check logs for details.'
        }
    }
} 